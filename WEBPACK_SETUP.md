# GUTS Webpack Build System

This document describes the new webpack-based build system for GUTS game projects.

## Overview

The webpack build system replaces the browser-based `Compiler.js` with a Node.js webpack build that:

- **Watches source files** in `projects/{ProjectName}/scripts/` and `/global/`
- **Parses project configuration** to determine required libraries, systems, and managers
- **Generates entry points** dynamically based on Environment/Scenes definitions
- **Bundles everything** with proper module resolution and tree-shaking
- **Integrates with the editor** to build automatically on save
- **Provides HMR** (Hot Module Replacement) for rapid development

## Architecture

### Components

1. **ConfigParser** (`build/config-parser.js`)
   - Parses project JSON configuration files
   - Extracts library paths from `configs.game.libraries` and `configs.server.libraries`
   - Extracts script requirements from `scenes.client` and `scenes.server`
   - Maps library names to actual file paths

2. **EntryGenerator** (`build/entry-generator.js`)
   - Generates dynamic entry point files for webpack
   - Creates three bundles:
     - `client-entry.js` → `game.js` (client game code)
     - `engine-entry.js` → `engine.js` (ModuleManager, BaseEngine, Engine)
     - `server-entry.js` → `game.js` (server game code, optional)

3. **Webpack Config** (`webpack.config.js`)
   - Multi-config setup for client and server bundles
   - Babel transpilation for ES6+ features
   - Source maps for debugging
   - Production optimization (minification, tree-shaking)

4. **Dev Server** (`webpack.dev.config.js`)
   - Hot module replacement
   - Live reload on file changes
   - Serves from `dist/client/` directory
   - Watches project files for changes

5. **Editor Integration** (`build/editor-integration.js`)
   - Express endpoints for triggering builds from editor
   - Build queue management
   - Status reporting

## Project Configuration

The build system reads your project's JSON configuration to determine what to include:

### Libraries (`configs.game.libraries` and `configs.server.libraries`)

```json
{
  "configs": {
    "game": {
      "libraries": [
        "threejs",
        "BaseECSGame",
        "Rapier",
        "SceneManager",
        "Entity",
        "Component"
      ]
    },
    "server": {
      "libraries": [
        "BaseSystem",
        "GameRoom",
        "ServerECSGame"
      ]
    }
  }
}
```

### Scenes (`scenes.client` and `scenes.server`)

```json
{
  "scenes": {
    "client": {
      "sceneData": [{
        "managers": [
          { "type": "GameManager" },
          { "type": "InputManager" }
        ],
        "systems": [
          { "type": "RenderSystem" },
          { "type": "MovementSystem" }
        ],
        "classes": [
          { "collection": "abilities", "baseClass": "BaseAbility" }
        ]
      }]
    }
  }
}
```

## Usage

### Command Line

```bash
# Install dependencies
npm install

# Build TurnBasedWarfare (development)
npm run build

# Build for production
npm run build:prod

# Watch mode (rebuild on file changes)
npm run build:watch

# Start webpack dev server with HMR
npm run dev

# Build a different project
PROJECT_NAME=Seeders npm run build
```

### From Editor

When you save a project in the editor (localhost only), webpack will automatically:

1. Run the old `Compiler.js` (for backwards compatibility)
2. Trigger a webpack build via `/webpack-build` endpoint
3. Generate fresh bundles in `dist/client/` and `dist/server/`

You can disable webpack builds by setting in your project config:

```json
{
  "configs": {
    "editor": {
      "useWebpack": false
    }
  }
}
```

### Build Scripts

```bash
# Manual build script
node build/build.js <ProjectName> [--watch] [--production]

# Examples:
node build/build.js TurnBasedWarfare
node build/build.js TurnBasedWarfare --watch
node build/build.js Seeders --production
```

## File Structure

```
GUTS/
├── build/
│   ├── config-parser.js       # Parses project JSON configs
│   ├── entry-generator.js     # Generates webpack entry points
│   ├── build.js               # Main build script
│   ├── editor-integration.js  # Editor webhook integration
│   └── .temp/                 # Generated entry files (auto-created)
│       ├── client-entry.js
│       ├── server-entry.js
│       └── engine-entry.js
├── webpack.config.js          # Webpack configuration
├── webpack.dev.config.js      # Dev server configuration
├── projects/
│   └── TurnBasedWarfare/
│       ├── config/
│       │   └── TURNBASEDWARFARE.json  # Project configuration
│       ├── scripts/
│       │   └── Scripts/
│       │       ├── abilities/js/
│       │       ├── managers/js/
│       │       ├── systems/js/
│       │       └── libraries/js/
│       └── dist/
│           ├── client/
│           │   ├── index.html
│           │   ├── game.js      # ← Generated by webpack
│           │   └── engine.js    # ← Generated by webpack
│           └── server/
│               └── game.js      # ← Generated by webpack
└── global/
    └── libraries/
        └── js/                  # Shared libraries
```

## How It Works

### Build Flow

1. **Parse Configuration**
   - Read `projects/{ProjectName}/config/{PROJECTNAME}.json`
   - Extract library dependencies from `configs.game.libraries`
   - Extract scene requirements from `scenes.client.managers/systems`

2. **Resolve File Paths**
   - Map library names to actual file paths
   - Support both `/global/libraries/js/` and project-specific paths
   - Skip external CDN libraries (handled separately)

3. **Generate Entry Points**
   - Create temporary entry files in `build/.temp/`
   - Import all required modules
   - Export as global namespace (`window.COMPILED_GAME`)
   - Set up class registry for runtime access

4. **Webpack Build**
   - Bundle all imports into single files
   - Transpile with Babel for compatibility
   - Generate source maps
   - Minify for production
   - Output to `dist/client/` and `dist/server/`

### Example Generated Entry Point

```javascript
// build/.temp/client-entry.js (auto-generated)

import ModuleManager from '/home/user/GUTS/engine/ModuleManager.js';
import BaseEngine from '/home/user/GUTS/engine/BaseEngine.js';
import Engine from '/home/user/GUTS/engine/Engine.js';

import lib_BaseECSGame from '/home/user/GUTS/global/libraries/js/BaseECSGame.js';
import lib_Entity from '/home/user/GUTS/global/libraries/js/Entity.js';

import mgr_GameManager from '/home/user/GUTS/projects/TurnBasedWarfare/scripts/Scripts/managers/js/GameManager.js';
import mgr_InputManager from '/home/user/GUTS/projects/TurnBasedWarfare/scripts/Scripts/managers/js/InputManager.js';

import sys_RenderSystem from '/home/user/GUTS/projects/TurnBasedWarfare/scripts/Scripts/systems/js/RenderSystem.js';
import sys_MovementSystem from '/home/user/GUTS/projects/TurnBasedWarfare/scripts/Scripts/systems/js/MovementSystem.js';

const Libraries = {
  BaseECSGame: lib_BaseECSGame,
  Entity: lib_Entity
};

const Managers = {
  GameManager: mgr_GameManager,
  InputManager: mgr_InputManager
};

const Systems = {
  RenderSystem: sys_RenderSystem,
  MovementSystem: sys_MovementSystem
};

window.COMPILED_GAME = {
  ready: Promise.resolve(),
  initialized: false,
  libraryClasses: Libraries,
  managers: Managers,
  systems: Systems,
  classRegistry: {
    getManager: (name) => Managers[name],
    getSystem: (name) => Systems[name],
    getLibrary: (name) => Libraries[name]
  },
  init: function(engine) {
    this.initialized = true;
    window.engine = engine;
  }
};

export default window.COMPILED_GAME;
```

## Development Workflow

### Option 1: Editor with Auto-Build

1. Start the editor server:
   ```bash
   npm run dev:server
   ```

2. Open editor in browser: `http://localhost:443`

3. Make changes to scripts in the editor or filesystem

4. Save project - webpack builds automatically

5. Reload `dist/client/index.html` to see changes

### Option 2: Watch Mode

1. Start webpack in watch mode:
   ```bash
   npm run build:watch
   ```

2. Edit source files in `/projects/TurnBasedWarfare/scripts/`

3. Webpack rebuilds automatically on file changes

4. Reload browser to see changes

### Option 3: Dev Server with HMR

1. Start webpack dev server:
   ```bash
   npm run dev
   ```

2. Browser opens automatically at `http://localhost:8080`

3. Edit source files

4. Changes hot-reload in browser automatically (no manual refresh needed)

## API Endpoints

### POST /webpack-build

Trigger a webpack build for a project.

**Request:**
```json
{
  "projectName": "TurnBasedWarfare",
  "production": false
}
```

**Response:**
```json
{
  "success": true,
  "projectName": "TurnBasedWarfare",
  "duration": "3.24",
  "output": "..."
}
```

### GET /webpack-build/status

Get current build status.

**Response:**
```json
{
  "building": true,
  "projectName": "TurnBasedWarfare",
  "duration": "1.52",
  "queued": 0
}
```

## Configuration Options

### webpack.config.js

```javascript
// Set project name
process.env.PROJECT_NAME = 'TurnBasedWarfare';

// Set build mode
process.env.NODE_ENV = 'production'; // or 'development'
```

### Webpack Aliases

The following aliases are available in your code:

```javascript
import Something from '@engine/ModuleManager.js';
import Library from '@global/libraries/js/Entity.js';
import Script from '@project/scripts/Scripts/managers/js/GameManager.js';
import Manager from '@scripts/managers/js/GameManager.js';
```

## Troubleshooting

### Build Fails: "Config not found"

Make sure your project configuration exists at:
```
projects/{ProjectName}/config/{PROJECTNAME}.json
```

### Build Fails: "Library not found"

Check that all libraries in `configs.game.libraries` exist in:
- `/global/libraries/js/`
- `/projects/{ProjectName}/scripts/Scripts/libraries/js/`

### Editor Doesn't Trigger Webpack

1. Check that you're running on `localhost`
2. Check that `useWebpack` is not set to `false` in editor config
3. Check server console for webpack integration messages

### Module Resolution Errors

Make sure all your source files use proper ES6 export syntax:

```javascript
// Good
export default class MyClass { }
export class Helper { }

// Bad (won't work with webpack)
class MyClass { }
window.MyClass = MyClass;
```

## Migration from Old Compiler

The webpack system runs **alongside** the old `Compiler.js` for backwards compatibility:

1. Old compiler still runs on save (generates initial bundles)
2. Webpack then runs and generates optimized bundles
3. Both produce the same output files (`game.js`, `engine.js`)
4. Webpack bundles overwrite the old compiler output

To fully migrate:

1. Test that webpack bundles work correctly
2. Set `useWebpack: true` in editor config
3. Consider disabling old compiler in future updates

## Performance

**Old Compiler (Browser-based):**
- Build time: ~5-10 seconds
- Runs in browser (blocks UI)
- No optimization

**Webpack (Node.js):**
- Build time: ~3-5 seconds (first build), ~1-2 seconds (incremental)
- Runs in background (doesn't block UI)
- Production optimization (minification, tree-shaking)
- 20-40% smaller bundle sizes

## Advanced Features

### Custom Webpack Plugins

Edit `webpack.config.js` to add plugins:

```javascript
plugins: [
  new webpack.DefinePlugin({ /* ... */ }),
  new YourCustomPlugin()
]
```

### Code Splitting

Currently disabled for simplicity. To enable:

```javascript
optimization: {
  splitChunks: {
    chunks: 'all'
  }
}
```

### External Libraries

CDN libraries (with `href` in config) are not bundled by webpack. They remain as external script tags in `index.html`.

## Support

For issues or questions:
- Check build logs in terminal
- Check browser console for runtime errors
- Review generated entry files in `build/.temp/`
- Inspect webpack stats output

## Future Improvements

- [ ] Automatic CSS bundling
- [ ] Asset optimization (images, models)
- [ ] Advanced code splitting
- [ ] TypeScript support
- [ ] Progressive Web App (PWA) support
